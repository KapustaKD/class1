// –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä –∫–ª–∞—Å –¥–ª—è Socket.io
class MultiplayerGame extends EducationalPathGame {
    constructor() {
        super();
        this.socket = null;
        this.isOnlineMode = false;
        this.roomId = null;
        this.playerId = null;
        this.isHost = false;
        this.spectators = [];
        
        this.setupMultiplayerElements();
        this.setupMultiplayerEventListeners();
    }
    
    setupMultiplayerElements() {
        this.modeSelection = document.getElementById('mode-selection');
        this.gameContainer = document.getElementById('game-container');
        this.onlinePanel = document.getElementById('online-panel');
        
        this.localModeBtn = document.getElementById('local-mode-btn');
        this.onlineModeBtn = document.getElementById('online-mode-btn');
        
        this.connectionStatus = document.getElementById('connection-status');
        this.statusIndicator = document.getElementById('status-indicator');
        this.statusText = document.getElementById('status-text');
        
        this.roomNameInput = document.getElementById('room-name');
        this.playerNameInput = document.getElementById('player-name');
        this.createRoomBtn = document.getElementById('create-room-btn');
        
        this.roomCodeInput = document.getElementById('room-code');
        this.joinPlayerNameInput = document.getElementById('join-player-name');
        this.joinRoomBtn = document.getElementById('join-room-btn');
        
        this.playersList = document.getElementById('players-list');
        this.playersContainer = document.getElementById('players-container');
        
        this.chatContainer = document.getElementById('chat-container');
        this.chatMessages = document.getElementById('chat-messages');
        this.chatInput = document.getElementById('chat-input');
        this.sendMessageBtn = document.getElementById('send-message-btn');
    }
    
    setupMultiplayerEventListeners() {
        this.localModeBtn.addEventListener('click', () => this.startLocalMode());
        this.onlineModeBtn.addEventListener('click', () => this.startOnlineMode());
        
        this.createRoomBtn.addEventListener('click', () => this.createRoom());
        this.joinRoomBtn.addEventListener('click', () => this.joinRoom());
        
        this.sendMessageBtn.addEventListener('click', () => this.sendMessage());
        this.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });
    }
    
    startLocalMode() {
        this.isOnlineMode = false;
        this.modeSelection.classList.add('hidden');
        this.gameContainer.classList.remove('hidden');
        this.onlinePanel.classList.add('hidden');
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏
        this.rulesModal.classList.remove('hidden');
    }
    
    startOnlineMode() {
        this.isOnlineMode = true;
        this.modeSelection.classList.add('hidden');
        this.onlinePanel.classList.remove('hidden');
        
        // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
        this.connectToServer();
    }
    
    connectToServer() {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ window.APP_CONFIG
        const socketUrl = window.APP_CONFIG ? window.APP_CONFIG.socketUrl : '';
        this.socket = io(socketUrl);
        
        this.socket.on('connect', () => {
            this.updateConnectionStatus(true, '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ');
            this.playerId = this.socket.id;
        });
        
        this.socket.on('disconnect', () => {
            this.updateConnectionStatus(false, '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
        });
        
        this.socket.on('connect_error', (error) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:', error);
            this.updateConnectionStatus(false, '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
            if (window.gameUI) {
                window.gameUI.showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.', 'error');
            }
        });
        
        this.socket.on('room_created', (data) => {
            this.roomId = data.roomId;
            this.isHost = true;
            this.updatePlayersList(data.players);
            this.showPlayersList();
            this.showChat();
            this.logMessage(`–ö—ñ–º–Ω–∞—Ç–∞ "${data.roomName}" —Å—Ç–≤–æ—Ä–µ–Ω–∞! –ö–æ–¥: ${this.roomId}`, 'system');
        });
        
        this.socket.on('room_joined', (data) => {
            this.roomId = data.roomId;
            this.isHost = false;
            this.updatePlayersList(data.players);
            this.showPlayersList();
            this.showChat();
            this.logMessage(`–ü—Ä–∏—î–¥–Ω–∞–Ω–æ –¥–æ –∫—ñ–º–Ω–∞—Ç–∏ "${data.roomName}"`, 'system');
        });
        
        this.socket.on('player_joined', (data) => {
            this.updatePlayersList(data.players);
            this.addChatMessage('system', `${data.player.name} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ –≥—Ä–∏`);
        });
        
        this.socket.on('player_left', (data) => {
            this.updatePlayersList(data.players);
            this.addChatMessage('system', `${data.player.name} –ø–æ–∫–∏–Ω—É–≤ –≥—Ä—É`);
        });
        
        this.socket.on('spectator_joined', (data) => {
            this.spectators.push(data.spectator);
            this.addChatMessage('spectator', `${data.spectator.name} —Å—Ç–∞–≤ —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä–æ–º`);
        });
        
        this.socket.on('spectator_left', (data) => {
            this.spectators = this.spectators.filter(s => s.id !== data.spectator.id);
            this.addChatMessage('spectator', `${data.spectator.name} –ø–µ—Ä–µ—Å—Ç–∞–≤ –±—É—Ç–∏ —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä–æ–º`);
        });
        
        this.socket.on('game_state_update', (data) => {
            this.syncGameState(data);
        });
        
        this.socket.on('dice_rolled', (data) => {
            this.handleRemoteDiceRoll(data);
        });
        
        this.socket.on('player_moved', (data) => {
            this.handleRemotePlayerMove(data);
        });
        
        this.socket.on('quest_started', (data) => {
            this.handleRemoteQuest(data);
        });
        
        this.socket.on('quest_vote', (data) => {
            this.handleQuestVote(data);
        });
        
        this.socket.on('chat_message', (data) => {
            this.addChatMessage(data.type, data.message, data.player);
        });
        
        this.socket.on('game_ended', (data) => {
            this.handleRemoteGameEnd(data);
        });
    }
    
    updateConnectionStatus(connected, text) {
        this.statusIndicator.className = `w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
        this.statusText.textContent = text;
    }
    
    createRoom() {
        const roomName = this.roomNameInput.value.trim();
        const playerName = this.playerNameInput.value.trim();
        
        if (!roomName || !playerName) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
            return;
        }
        
        this.socket.emit('create_room', {
            roomName,
            playerName,
            playerId: this.playerId
        });
    }
    
    joinRoom() {
        const roomCode = this.roomCodeInput.value.trim();
        const playerName = this.joinPlayerNameInput.value.trim();
        
        if (!roomCode || !playerName) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
            return;
        }
        
        this.socket.emit('join_room', {
            roomCode,
            playerName,
            playerId: this.playerId
        });
    }
    
    updatePlayersList(players) {
        this.playersContainer.innerHTML = '';
        
        players.forEach(player => {
            const playerCard = document.createElement('div');
            playerCard.className = 'player-card';
            playerCard.innerHTML = `
                <div style="color: ${player.color};">${player.name}</div>
                <div class="text-sm text-gray-400">${player.class?.name || '–ù–µ –æ–±—Ä–∞–Ω–æ'}</div>
                <div class="text-sm">${player.points || 0} –û–û</div>
            `;
            
            if (player.id === this.playerId) {
                playerCard.classList.add('current-player');
            }
            
            this.playersContainer.appendChild(playerCard);
        });
        
        // –î–æ–¥–∞—î–º–æ —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä—ñ–≤
        this.spectators.forEach(spectator => {
            const spectatorCard = document.createElement('div');
            spectatorCard.className = 'player-card spectator';
            spectatorCard.innerHTML = `
                <div>üëÅÔ∏è ${spectator.name}</div>
                <div class="text-sm text-gray-400">–°–ø–µ–∫—Ç–∞—Ç–æ—Ä</div>
            `;
            this.playersContainer.appendChild(spectatorCard);
        });
    }
    
    showPlayersList() {
        this.playersList.classList.remove('hidden');
    }
    
    showChat() {
        this.chatContainer.classList.remove('hidden');
    }
    
    sendMessage() {
        const message = this.chatInput.value.trim();
        if (!message) return;
        
        this.socket.emit('chat_message', {
            message,
            playerId: this.playerId,
            roomId: this.roomId
        });
        
        this.chatInput.value = '';
    }
    
    addChatMessage(type, message, player = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        
        let prefix = '';
        if (type === 'player' && player) {
            prefix = `${player.name}: `;
        } else if (type === 'system') {
            prefix = '[–°–∏—Å—Ç–µ–º–∞] ';
        } else if (type === 'spectator' && player) {
            prefix = `[–°–ø–µ–∫—Ç–∞—Ç–æ—Ä] ${player.name}: `;
        }
        
        messageDiv.textContent = prefix + message;
        this.chatMessages.appendChild(messageDiv);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }
    
    // –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–µ—Ç–æ–¥—ñ–≤ –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä—É
    initializeGame() {
        if (this.isOnlineMode) {
            // –í –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ –≥—Ä–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
            this.socket.emit('start_game', { roomId: this.roomId });
        } else {
            // –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º
            super.initializeGame();
        }
    }
    
    rollTheDice() {
        if (this.isOnlineMode) {
            // –í –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ —Ç—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∫–∏–¥–∞—Ç–∏ –∫—É–±–∏–∫
            if (this.isHost && this.gameActive) {
                this.socket.emit('roll_dice', { roomId: this.roomId });
            }
        } else {
            // –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º
            super.rollTheDice();
        }
    }
    
    handleRemoteDiceRoll(data) {
        const player = this.players.find(p => p.id === data.playerId);
        if (!player) return;
        
        this.rollDiceBtn.disabled = true;
        
        const rotations = {
            1: 'rotateY(0deg)',
            2: 'rotateY(-90deg)',
            3: 'rotateY(-180deg)',
            4: 'rotateY(90deg)',
            5: 'rotateX(-90deg)',
            6: 'rotateX(90deg)'
        };
        
        this.diceInner.style.transform = `rotateX(${Math.random()*360}deg) rotateY(${Math.random()*360}deg)`;
        setTimeout(() => {
            this.diceInner.style.transform = `${rotations[data.roll]} translateZ(40px)`;
            this.movePlayer(player, data.move);
        }, 1000);
        
        this.logMessage(`${player.name} (${player.class.name}) –≤–∏–∫–∏–Ω—É–≤ ${data.roll}. –†—É—Ö: ${data.move}.`, 'roll');
    }
    
    handleRemotePlayerMove(data) {
        const player = this.players.find(p => p.id === data.playerId);
        if (!player) return;
        
        player.position = data.position;
        this.updatePawnPosition(player);
        this.logMessage(`${player.name} –ø–µ—Ä–µ–º—ñ—Å—Ç–∏–≤—Å—è –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É ${data.position}.`, 'system');
    }
    
    syncGameState(data) {
        this.players = data.players;
        this.currentPlayerIndex = data.currentPlayerIndex;
        this.gameActive = data.gameActive;
        
        this.updateUI();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó —Ñ—ñ—à–æ–∫
        this.players.forEach(player => {
            this.updatePawnPosition(player);
        });
        
        if (data.gameActive) {
            this.rollDiceBtn.disabled = false;
        }
    }
    
    handleRemoteQuest(data) {
        // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –∫–≤–µ—Å—Ç—ñ–≤
        this.showQuestModal(data.title, data.description, data.buttons);
    }
    
    handleQuestVote(data) {
        // –û–±—Ä–æ–±–∫–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –≤ –∫–≤–µ—Å—Ç–∞—Ö
        this.addChatMessage('system', `${data.player.name} –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–≤ –∑–∞ "${data.choice}"`);
    }
    
    handleRemoteGameEnd(data) {
        this.endGame(data.winner, data.message);
    }
    
    // –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–µ—Ç–æ–¥—ñ–≤ –∫–≤–µ—Å—Ç—ñ–≤ –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ—î—Ä—É
    triggerPvpQuest(player) {
        if (this.isOnlineMode) {
            this.socket.emit('start_pvp_quest', {
                roomId: this.roomId,
                playerId: player.id
            });
        } else {
            super.triggerPvpQuest(player);
        }
    }
    
    triggerCreativeQuest(player) {
        if (this.isOnlineMode) {
            this.socket.emit('start_creative_quest', {
                roomId: this.roomId,
                playerId: player.id
            });
        } else {
            super.triggerCreativeQuest(player);
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è —Å–ø–µ–∫—Ç–∞—Ç–æ—Ä—ñ–≤
    voteForCreativeQuest(choice) {
        if (this.isOnlineMode) {
            this.socket.emit('creative_quest_vote', {
                roomId: this.roomId,
                choice,
                voterId: this.playerId
            });
        }
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —ñ–Ω—à–∏—Ö —Ñ–∞–π–ª–∞—Ö
window.MultiplayerGame = MultiplayerGame;
